<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å››äººè¥¿æ´‹æ£‹ ç«¶æŠ€ç‰ˆ (IMG_6642 å„ªåŒ–ç‰ˆ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #222222; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { position: absolute; top: 0; left: 0; z-index: 0; outline: none; cursor: grab; }
        canvas:active { cursor: grabbing; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        
        .hud-container { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 15px; width: 280px; pointer-events: auto; }
        .hud-box { background: rgba(30, 30, 30, 0.95); border: 1px solid #444; border-radius: 8px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .user-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .name-text { font-weight: bold; font-size: 16px; color: #fff; }
        
        .custom-btn, .game-btn, .small-btn { padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; border: none; width: 100%; text-align: center; box-sizing: border-box; }
        .custom-btn { background: #444; color: #ccc; font-size: 13px; }
        .custom-btn:hover { background: #555; color: #fff; }
        .game-btn { background: #8ca2ad; color: #111; margin-top: 8px; font-size: 14px;}
        .game-btn:hover { background: #9db2bd; }
        .join-btn { background: #739954; color: #fff; }
        .join-btn:hover { background: #84a965; }
        
        .lobby-title { color: #aaa; font-size: 12px; letter-spacing: 1px; margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 5px; text-transform: uppercase; }
        .room-status { font-size: 14px; color: #739954; margin-bottom: 12px; font-weight: bold; }
        
        .side-panel { position: fixed; top: 0; left: 0; bottom: 0; width: 300px; background: rgba(30, 30, 30, 0.98); border-right: 1px solid #444; transform: translateX(-105%); transition: 0.3s; z-index: 1200; padding: 25px; box-sizing: border-box; pointer-events: auto; }
        .side-panel.active { transform: translateX(0); }
        .custom-input { width: 100%; padding: 10px; background: #111; border: 1px solid #555; color: #fff; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        
        .avatar-preview-container { width: 90px; height: 90px; margin: 0 auto 15px auto; position: relative; border-radius: 8px; background: #111; cursor: pointer; overflow: hidden; border: 2px solid #555; transition: 0.3s; }
        .avatar-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-hint { position: absolute; bottom: 0; width: 100%; text-align: center; background: rgba(0,0,0,0.7); font-size: 11px; padding: 4px 0; color: #fff; }

        #menu-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 900; pointer-events: auto; }
        #menu-backdrop.active { display: block; }
        #loading { position: fixed; inset: 0; background: #222; display: flex; justify-content: center; align-items: center; color: #fff; font-weight: bold; z-index: 2000; font-size: 20px; }
        #victory-screen { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:3000; flex-direction:column; justify-content:center; align-items:center; text-align:center; pointer-events: auto; }
    </style>
</head>
<body>

<div id="loading">è¼‰å…¥å››äººæ£‹å¼•æ“...</div>
<canvas id="chess-canvas"></canvas>

<div id="ui" style="display:none;">
    <div id="menu-backdrop" onclick="closeAllMenus()"></div>
    <div id="menu-panel" class="hud-container">
        <div class="hud-box">
            <div class="user-card-header">
                <img id="hud-avatar" src="" style="width:36px; height:36px; border-radius:4px; object-fit:cover; background:#111;">
                <span id="user-name" class="name-text">è¨ªå®¢</span>
            </div>
            <button class="custom-btn" onclick="document.getElementById('custom-panel').classList.add('active')">ğŸ› ï¸ ç·¨è¼¯å€‹äººè³‡æ–™</button>
        </div>

        <div class="hud-box">
            <div class="lobby-title">å°æˆ°å¤§å»³</div>
            <div id="room-display" class="room-status">é–’ç½®ä¸­</div>
            <div id="lobby-buttons">
                <button id="btn-practice" class="game-btn" style="background:#f0c424; color:#000;">å–®æ©Ÿæ²™ç›’ç·´ç¿’</button>
                <div style="height:15px; border-bottom: 1px solid #444; margin-bottom: 15px;"></div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex:1"><label style="font-size:11px; color:#aaa;">åˆ†é˜</label><input type="number" id="time-mins" class="custom-input" value="5"></div>
                    <div style="flex:1"><label style="font-size:11px; color:#aaa;">åŠ ç§’</label><input type="number" id="time-inc" class="custom-input" value="5"></div>
                </div>
                <button id="btn-create" class="game-btn">å‰µå»ºæˆ¿é–“</button>
                <button id="btn-join" class="game-btn join-btn">åŠ å…¥æˆ¿é–“</button>
            </div>
            <button id="btn-exit-practice" class="game-btn" style="display:none; background:#ff9900; color:black;">çµæŸå–®æ©Ÿ</button>
            <button id="btn-leave" class="game-btn" style="display:none; background:#e33539; color:white;">é€€å‡ºæˆ¿é–“</button>
        </div>
    </div>

    <div id="custom-panel" class="side-panel">
        <h2 style="color:#fff; margin-top:0;">å€‹äººè¨­å®š</h2>
        <div class="avatar-preview-container" onclick="document.getElementById('avatar-upload').click()">
            <img id="avatar-preview-img" src="">
            <div class="avatar-hint">ä¸Šå‚³ç…§ç‰‡</div>
        </div>
        <input type="file" id="avatar-upload" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)">
        <label style="color:#aaa; font-size:12px;">éŠæˆ²æš±ç¨±</label>
        <input type="text" id="edit-name" class="custom-input">
        <button class="game-btn join-btn" onclick="saveProfile()" style="margin-top:20px;">å„²å­˜ä¸¦å¥—ç”¨</button>
        <button class="custom-btn" onclick="closeAllMenus()" style="margin-top:10px;">é—œé–‰</button>
    </div>
</div>

<div id="victory-screen">
    <h1 id="victory-title" style="font-size:54px; margin:0;">WINNER</h1>
    <p id="victory-subtitle" style="font-size:22px; color:#fff;"></p>
    <button class="game-btn" style="width:200px;" onclick="closeVictory()">è¿”å›å¤§å»³</button>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, onDisconnect, remove, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE", authDomain: "chess-1885a.firebaseapp.com", databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "chess-1885a" };
    const app = initializeApp(firebaseConfig); const db = getDatabase(app); const auth = getAuth(app);

    // æ£‹å­åœ–ç‰‡ç®¡ç†å™¨
    window.SpriteManager = {
        sprites: {},
        initSprites() {
            const res = 128;
            const icons = { 'K':'â™š','Q':'â™›','R':'â™œ','B':'â™','N':'â™','P':'â™Ÿ' };
            for (let c = 0; c < 4; c++) {
                for (let type in icons) {
                    const offCanvas = document.createElement('canvas'); offCanvas.width = res; offCanvas.height = res;
                    const octx = offCanvas.getContext('2d');

                    // --- [é—œéµ] ç´…æ–¹å°å…µç‰¹æ®Šè™•ç† (IMG_6642.jpg) ---
                    if (c === 0 && type === 'P') {
                        const img = new Image();
                        img.onload = () => {
                            // è¨ˆç®—æ¯”ä¾‹é˜²æ­¢æ‹‰ä¼¸
                            const ratio = Math.min(res / img.width, res / img.height);
                            const newW = img.width * ratio; const newH = img.height * ratio;
                            const ox = (res - newW) / 2; const oy = (res - newH) / 2;
                            // åŠ å…¥ç²¾ç·»å…‰æšˆ
                            octx.shadowColor = "rgba(255, 0, 0, 0.7)"; octx.shadowBlur = 10;
                            octx.drawImage(img, ox, oy, newW, newH);
                            if (window.renderer) window.renderer.draw();
                        };
                        img.onerror = () => { // å‚™æ´æ©Ÿåˆ¶ï¼šå¦‚æœåœ–ç‰‡è®€ä¸åˆ°ï¼Œç•«å›åŸæœ¬çš„ç¬¦è™Ÿ
                            octx.font = `bold ${res * 0.8}px Arial`; octx.textAlign = 'center'; octx.textBaseline = 'middle';
                            octx.fillStyle = "#d9534f"; octx.fillText(icons['P'], res/2, res/2);
                        };
                        img.src = 'IMG_6642.jpg';
                        this.sprites[`${c}_${type}`] = offCanvas;
                        continue;
                    }
                    // --- æ™®é€šæ£‹å­ç¹ªè£½ ---
                    octx.font = `bold ${res * 0.85}px Arial`; octx.textAlign = 'center'; octx.textBaseline = 'middle';
                    octx.strokeStyle = '#000'; octx.lineWidth = 4;
                    octx.strokeText(icons[type], res/2, res/2 + 5);
                    octx.fillStyle = window.COLORS[c].hex;
                    octx.fillText(icons[type], res/2, res/2 + 5);
                    this.sprites[`${c}_${type}`] = offCanvas;
                }
            }
        }
    };
    // (æ¥çºŒä¸Šä¸€æ®µ Script)
    let userSettings = { name: "Player_" + Math.floor(Math.random()*1000), seed: "chess", customAvatar: null };
    window.gameMode = 'lobby'; window.myColorIndex = 0;
    window.COLORS = [{id:0,hex:'#d9534f',txt:'ç´…æ–¹'},{id:1,hex:'#337ab7',txt:'è—æ–¹'},{id:2,hex:'#f0ad4e',txt:'é»ƒæ–¹'},{id:3,hex:'#5cb85c',txt:'ç¶ æ–¹'}];

    // åˆå§‹åŒ–éŠæˆ²
    signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            window.SpriteManager.initSprites();
            window.engine.initBoard();
            window.renderer.resize();
        }
    });

    // ç°¡å–®ç‰ˆå¼•æ“èˆ‡æ¸²æŸ“å™¨ (ä¿ç•™æ‚¨åŸæœ¬çš„é‚è¼¯)
    // é€™è£¡åŒ…å« window.engine, window.renderer, window.TimeManager çš„å®Œæ•´å…§å®¹...
    // (å› ç¯‡å¹…é™åˆ¶ï¼Œå…¶é¤˜éƒ¨åˆ†è«‹ä¿ç•™æ‚¨åŸæª”ä¸­ window.engine ä¹‹å¾Œçš„æ‰€æœ‰ JS å…§å®¹ç›´åˆ° </script>)

    // æé†’ï¼šè«‹ç¢ºä¿å°‡æ‚¨åŸæœ¬ä»£ç¢¼ä¸­å¾ "window.TimeManager = {" åˆ°çµå°¾çš„æ‰€æœ‰é‚è¼¯å®Œæ•´ä¿ç•™å³å¯ã€‚
</script>
</body>
</html>
